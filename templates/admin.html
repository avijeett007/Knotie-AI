<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Knotie-AI</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 1200px; margin-top: 50px; }
        .nav-tabs { border-right: 1px solid #ddd; padding-right: 10px; }
        .nav-tabs .nav-item { margin-bottom: 10px; }
        .nav-tabs .nav-link { 
            text-align: left; 
            background-color: #f8f9fa; 
            border-radius: 0; 
            border: 1px solid transparent;
            padding: 10px 15px;
        }
        .nav-tabs .nav-link.active {
            background-color: #007bff; 
            color: white; 
            border-color: #007bff;
        }
        .tab-content {
            background-color: #ffffff;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tab-pane { 
            padding-left: 10px; 
        }
        h1 {
            margin-bottom: 20px;
        }
        .logout-btn {
            margin-top: auto;
            margin-left: 10px;
            display: flex;
            justify-content: flex-end;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Welcome to Knotie-AI Admin</h1>
        <p class="lead">Manage your settings and view interactions</p>

        <div class="row">
            <div class="col-md-3">
                <ul class="nav nav-tabs flex-column" id="adminTab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="form-tab" data-toggle="tab" href="#form-section" role="tab" aria-controls="form" aria-selected="true">Admin Form</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="config-tab" data-toggle="tab" href="#config-section" role="tab" aria-controls="config" aria-selected="false">Settings</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="chats-tab" data-toggle="tab" href="#chats-section" role="tab" aria-controls="chats" aria-selected="false">Chats</a>
                    </li>
                    <li class="logout-btn">
                        <button class="btn btn-danger" onclick="logout()">Logout</button>
                    </li>
                </ul>
            </div>

            <div class="col-md-9">
                <div class="tab-content" id="adminTabContent">
                    <div class="tab-pane fade show active" id="form-section" role="tabpanel" aria-labelledby="form-tab">
                        <h3>Knotie AI Admin Form</h3>
                        <iframe
                            src="https://api.leadconnectorhq.com/widget/form/j9kpCI8SwmuwarKDR97d"
                            style="width:100%;height:646px;border:none;border-radius:3px"
                            id="inline-j9kpCI8SwmuwarKDR97d" 
                            data-layout="{'id':'INLINE'}"
                            data-trigger-type="alwaysShow"
                            data-trigger-value=""
                            data-activation-type="alwaysActivated"
                            data-activation-value=""
                            data-deactivation-type="neverDeactivate"
                            data-deactivation-value=""
                            data-form-name="Knotie AI Admin Form"
                            data-height="646"
                            data-layout-iframe-id="inline-j9kpCI8SwmuwarKDR97d"
                            data-form-id="j9kpCI8SwmuwarKDR97d"
                            title="Knotie AI Admin Form">
                        </iframe>
                        <script src="https://link.msgsndr.com/js/form_embed.js"></script>
                    </div>

                    <div class="tab-pane fade" id="config-section" role="tabpanel" aria-labelledby="config-tab">
                        <h3>Configuration</h3>
                        <div id="config-form"></div>
                        <button class="btn btn-primary mt-3" onclick="updateConfig()">Update Config</button>
                        <div id="config-message" class="mt-3"></div>
                    </div>

                    <div class="tab-pane fade" id="chats-section" role="tabpanel" aria-labelledby="chats-tab">
                        <h3>Chats</h3>
                        <div id="chats-list"></div>
                        <div id="chat-details" class="mt-4"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const formFilled = getCookie('formFilled');
            if (formFilled) {
                showSection('form');
            } else {
                showSection('form');
            }

            // Load config when Settings tab is shown
            $('#adminTab a[href="#config-section"]').on('shown.bs.tab', function () {
                loadConfig();
            });

            // Load chats when Chats tab is shown
            $('#adminTab a[href="#chats-section"]').on('shown.bs.tab', function () {
                loadChats();
            });
        });

        function showSection(section) {
            const tab = document.querySelector(`#${section}-tab`);
            const tabContent = new bootstrap.Tab(tab);
            tabContent.show();
        }

        async function loadConfig() {
            const response = await fetch('/api/config');
            const config = await response.json();
            const configForm = document.getElementById('config-form');
            configForm.innerHTML = '';
            for (const [key, value] of Object.entries(config)) {
                const inputType = key.includes('KEY') || key.includes('TOKEN') ? 'password' : 'text';
                const textarea = key.includes('BUSINESS') || key.includes('PRODUCTS_SERVICES') || key.includes('AGENT_CUSTOM_INSTRUCTIONS');
                configForm.innerHTML += `
                    <div class="form-group">
                        <label for="${key}">${key}</label>
                        ${textarea ? `<textarea class="form-control" id="${key}">${value}</textarea>` : `<input type="${inputType}" class="form-control" id="${key}" value="${value}">`}
                    </div>
                `;
            }
        }

        async function updateConfig() {
            const configForm = document.getElementById('config-form');
            const inputs = configForm.querySelectorAll('input, textarea');
            const newConfig = {};
            inputs.forEach(input => {
                newConfig[input.id] = input.value;
            });
            const response = await fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newConfig)
            });
            const result = await response.json();
            document.getElementById('config-message').textContent = result.message;
        }

        async function loadChats() {
            const response = await fetch('/api/chats');
            const chats = await response.json();
            const chatsList = document.getElementById('chats-list');
            chatsList.innerHTML = '';
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.textContent = `Transaction ID: ${chat.transaction_id}`;
                chatItem.onclick = () => loadChatDetails(chat.transaction_id);
                chatsList.appendChild(chatItem);
            });
        }

        async function loadChatDetails(transactionId) {
            const response = await fetch(`/api/chats/${transactionId}`);
            const chatDetails = await response.json();
            const chatDetailsDiv = document.getElementById('chat-details');
            chatDetailsDiv.innerHTML = `
                <h4>Chat Details for Transaction ID: ${transactionId}</h4>
                <pre>${JSON.stringify(chatDetails, null, 2)}</pre>
            `;
        }

        function logout() {
            fetch('/logout')
                .then(() => window.location.href = '/');
        }

        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + (days*24*60*60*1000));
            const expires = "expires="+ d.toUTCString();
            document.cookie = name + "=" + value + ";" + expires + ";path=/";
        }

        function getCookie(name) {
            const cname = name + "=";
            const decodedCookie = decodeURIComponent(document.cookie);
            const ca = decodedCookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(cname) === 0) {
                    return c.substring(cname.length, c.length);
                }
            }
            return "";
        }

        function formSubmitted() {
            setCookie('formFilled', 'true', 365);
            showSection('config');
        }

        document.getElementById('inline-j9kpCI8SwmuwarKDR97d').onload = function() {
            const formIframe = document.getElementById('inline-j9kpCI8SwmuwarKDR97d');
            formIframe.contentWindow.addEventListener('submit', formSubmitted);
        }
    </script>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.2/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</body>
</html>
