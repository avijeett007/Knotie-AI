<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Knotie-AI</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .container { max-width: 800px; margin-top: 50px; }
        .config-section, .chats-section, .form-section { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Welcome to Knotie-AI Admin</h1>
        <p class="lead">Manage your settings and view interactions</p>
        <button class="btn btn-secondary" onclick="showSection('config')">Settings</button>
        <button class="btn btn-secondary" onclick="showSection('chats')">Chats</button>
        <button class="btn btn-secondary" onclick="showSection('form')">Admin Form</button>
        <button class="btn btn-danger float-right" onclick="logout()">Logout</button>

        <div class="config-section mt-4">
            <h3>Configuration</h3>
            <div id="config-form"></div>
            <button class="btn btn-primary" onclick="updateConfig()">Update Config</button>
            <div id="config-message" class="mt-3"></div>
        </div>

        <div class="chats-section mt-4">
            <h3>Chats</h3>
            <div id="chats-list"></div>
            <div id="chat-details" class="mt-4"></div>
        </div>

        <div class="form-section mt-4">
            <h3>Knotie AI Admin Form</h3>
            <iframe
                src="https://api.leadconnectorhq.com/widget/form/j9kpCI8SwmuwarKDR97d"
                style="width:100%;height:646px;border:none;border-radius:3px"
                id="inline-j9kpCI8SwmuwarKDR97d" 
                data-layout="{'id':'INLINE'}"
                data-trigger-type="alwaysShow"
                data-trigger-value=""
                data-activation-type="alwaysActivated"
                data-activation-value=""
                data-deactivation-type="neverDeactivate"
                data-deactivation-value=""
                data-form-name="Knotie AI Admin Form"
                data-height="646"
                data-layout-iframe-id="inline-j9kpCI8SwmuwarKDR97d"
                data-form-id="j9kpCI8SwmuwarKDR97d"
                title="Knotie AI Admin Form">
            </iframe>
            <script src="https://link.msgsndr.com/js/form_embed.js"></script>
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Check if the user has already filled out the form
            const formFilled = getCookie('formFilled');
            if (formFilled) {
                showSection('config');
            } else {
                showSection('form');
            }
        });

        function showSection(section) {
            document.querySelector('.config-section').style.display = 'none';
            document.querySelector('.chats-section').style.display = 'none';
            document.querySelector('.form-section').style.display = 'none';

            if (section === 'config') {
                document.querySelector('.config-section').style.display = 'block';
                loadConfig();
            } else if (section === 'chats') {
                document.querySelector('.chats-section').style.display = 'block';
                loadChats();
            } else if (section === 'form') {
                document.querySelector('.form-section').style.display = 'block';
            }
        }

        async function loadConfig() {
            const response = await fetch('/api/config');
            const config = await response.json();
            const configForm = document.getElementById('config-form');
            configForm.innerHTML = '';
            for (const [key, value] of Object.entries(config)) {
                const inputType = key.includes('KEY') || key.includes('TOKEN') ? 'password' : 'text';
                const textarea = key.includes('BUSINESS') || key.includes('PRODUCTS_SERVICES') || key.includes('AGENT_CUSTOM_INSTRUCTIONS');
                configForm.innerHTML += `
                    <div class="form-group">
                        <label for="${key}">${key}</label>
                        ${textarea ? `<textarea class="form-control" id="${key}">${value}</textarea>` : `<input type="${inputType}" class="form-control" id="${key}" value="${value}">`}
                    </div>
                `;
            }
        }

        async function updateConfig() {
            const configForm = document.getElementById('config-form');
            const inputs = configForm.querySelectorAll('input, textarea');
            const newConfig = {};
            inputs.forEach(input => {
                newConfig[input.id] = input.value;
            });
            const response = await fetch('/api/config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(newConfig)
            });
            const result = await response.json();
            document.getElementById('config-message').textContent = result.message;
        }

        async function loadChats() {
            // Fetch chats from the backend
            const response = await fetch('/api/chats'); // Create an endpoint to fetch chat list
            const chats = await response.json();
            const chatsList = document.getElementById('chats-list');
            chatsList.innerHTML = '';
            chats.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = 'chat-item';
                chatItem.textContent = `Transaction ID: ${chat.transaction_id}`;
                chatItem.onclick = () => loadChatDetails(chat.transaction_id);
                chatsList.appendChild(chatItem);
            });
        }

        async function loadChatDetails(transactionId) {
            const response = await fetch(`/api/chats/${transactionId}`); // Create an endpoint to fetch chat details
            const chatDetails = await response.json();
            const chatDetailsDiv = document.getElementById('chat-details');
            chatDetailsDiv.innerHTML = `
                <h4>Chat Details for Transaction ID: ${transactionId}</h4>
                <pre>${JSON.stringify(chatDetails, null, 2)}</pre>
            `;
        }

        function logout() {
            fetch('/logout')
                .then(() => window.location.href = '/');
        }

        // Utility functions for cookie management
        function setCookie(name, value, days) {
            const d = new Date();
            d.setTime(d.getTime() + (days*24*60*60*1000));
            const expires = "expires="+ d.toUTCString();
            document.cookie = name + "=" + value + ";" + expires + ";path=/";
        }

        function getCookie(name) {
            const cname = name + "=";
            const decodedCookie = decodeURIComponent(document.cookie);
            const ca = decodedCookie.split(';');
            for(let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') {
                    c = c.substring(1);
                }
                if (c.indexOf(cname) === 0) {
                    return c.substring(cname.length, c.length);
                }
            }
            return "";
        }

        function formSubmitted() {
            setCookie('formFilled', 'true', 365);  // Save a cookie for 1 year
            showSection('config');  // Show the settings section after form is filled
        }

        // Bind the form submission to formSubmitted function
        document.getElementById('inline-j9kpCI8SwmuwarKDR97d').onload = function() {
            const formIframe = document.getElementById('inline-j9kpCI8SwmuwarKDR97d');
            formIframe.contentWindow.addEventListener('submit', formSubmitted);
        }
    </script>
</body>
</html>
